# 00:35 Creating a service
 
 Today's note and probably a lot in the future are about my journey with unix. I'm trying to understand services a little better.
In this particular case, I've created a timer for a service that uses reflector to update arch linux mirrorlist located in `/etc/pacman.d/mirrorlist`

I first created a service on `/etc/systemd/system` called `reflector.service`. It looks like this:

```shell
[Unit]
Description=Update Arch Linux mirrorlist with reflector
Wants=network-online.target
After=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/bin/reflector --protocol https --latest 10 --sort rate --save /etc/pacman.d/mirrorlist
```

after that a timer that is on the same location, called `reflector-timer`, that looks like this

```shell
[Unit]
Description=Schedule Arch Linux mirrorlist update

[Timer]
OnCalendar=weekly
Persistent=true

[Install]
WantedBy=timers.target
```

I can check the timer status with this:

```shell
systemctl status reflector.timer
```

Start the refletor service at any time with

```shell
sudo systemctl start reflector.service
```

And I started the timer like this:

```shell
sudo systemctl enable reflector.timer
sudo systemctl start reflector.timer
```


# 12:30 - A problem with suspending the system

Another long troubleshoot. Whenever I suspended the laptop everything froze and I had to reboot the system.

First thing was of course to update the system with `sudo pacman -Syu`

### Kernel Parameters

Certain kernel parameters can improve hardware compatibility, especially with sleep states

After that I've checked my bootloader which is `systed-boot`. I knew I installed it but to check which one it is with `bootctl status`

I was using the last version of the kernel which was Linux kernel 6.12.1-arch1-1

`/boot/loader/entries` has the following files

```plain
2024-11-17_12-14-43_linux-fallback.conf
2024-11-17_12-14-43_linux-lts-fallback.conf
2024-11-17_12-14-43_linux-lts.conf
2024-11-17_12-14-43_linux.conf
```

The default kernel was the `linux.conf`
`linux-lts.conf` is the LTS kernel, which I installed, but it's not in use.
The fallback options are for troubleshooting and use a generic initramfs.

So I edited the `linux.conf` which looked like this:
```plain
title Arch Linux
linux /vmlinuz-linux
initrd /initramfs-linux.img
options root=PARTUUID=17a4b077-180c-4310-8a22-7e72bcf92312 zswap.enabled=0 rw rootfstype=ext4
```

In the options I added:

```plain
loglevel=3 nowatchdog acpi_sleep=nonvs
```

`loglevel=3`: Reduces system message verbosity, focusing on errors and warnings.
`nowatchdog`: Disables the kernel's watchdog timer, which might prevent hangs during suspend/resume. `acpi_sleep=nonvs`: Changes the ACPI sleep state behavior to fix suspend/resume problems.

Disabling the watchdog  could help troubleshoot or eliminate it as a cause of your freeze:
- Prevents the watchdog from interfering with suspend/resume.
- Simplifies diagnostics by removing a potential source of conflict.

There were some risks involved, but for personal laptops or desktops those were minimal because I could always manually reboot if needed

After rebooting with these new options I checked  the file `/proc/cmdline` and everything was fine (this is a single line of text with the kernel parameters provided during boot)

The problem continued, so I rolledback the changes on the options to isolate the problem. It was time for a new approach.

### Testing a different sleep mode

Linux suppoorts multiple sleep modes, and the default could not be working well with my hardware. The two modes available were:
- **S2idle** (lightweight sleep; default for modern systems)
- **Deep** (deeper power-saving mode)

So I've checked which one I was using with
```shell
bat /sys/power/mem_sleep
```

The output was: `s2idle [deep]`, which meant that Deep was the active mode.

I switched to S2idle with `echo s2idle | sudo tee /sys/power/mem_sleep`. 

2Sidle is less agressive in powering down components. Some devices (especially modern laptops) are optimized for S2idle due to its similarity to "modern standby" on Windows.

Deep is a true low-power state where most components are powered down. It can be problematic if drivers, firmware, or hardware components (e.g. GPU, keyboard, touchpad) don't fully support resuming correctly.

After rebooting, the suspend mode still froze the system, so I reverted it do Deep.

### Troubleshoot graphic drivers

I'm using Wayland (not X11). Unlike X11, Wayland compositors like Hyprland interact more directly with the GPU through modern APIs such as DRM (Direct Rendering Manager) and Mesa. This means some X11-specific settings (like `xf86-video-intel` or `/etc/X11/xorg.conf.d/` configurations) won't apply in Wayland.

So i first made sure I had the drivers installed and updated with

```shell
sudo pacman -Syu mesa libva-intel-driver vulkan-intel
```

after updating mesa I did the following 
```shell
lspci -k | grep -A 2 -E "VGA|3D"
```
 and I got 
 ```plain
 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Lucienne (rev c1) 
 Subsystem: Lenovo Device 5097 
 Kernel driver in use: amdgpu

```

amdgpu is the correct driver for my laptop. I tried suspending the system and it still froze. 

I inspected the logs for AMD GPU-related errors with:

```bash
dmesg | grep -i amdgpu
```

And checked for errors, timeouts or failures. I found the following:

```bash
[ 4.720791] amdgpu 0000:04:00.0: amdgpu: psp gfx command LOAD_TA(0x1) failed and response status is (0x7)
[ 4.721029] amdgpu 0000:04:00.0: amdgpu: psp gfx command INVOKE_CMD(0x3) failed and response status is (0x4)
[ 4.721037] amdgpu 0000:04:00.0: amdgpu: Secure display: Generic Failure.
[ 4.721056] amdgpu 0000:04:00.0: amdgpu: SECUREDISPLAY: query securedisplay TA failed. ret 0x0
[ 4.721299] amdgpu 0000:04:00.0: amdgpu: SMU is initialized successfully!
```

These log messages indicate that there could be an issue with the Secure Display (SECUREDISPLAY) feature of the AMD GPU. While the last line confirms that the SMU (System Management Unit) initialized successfully, the preceding errors suggested that certain PSP (Platform Security Processor) commands related to secure display functionality failed.

These errors could indicate firmware or driver incompatibility that could disrupt suspend/resume operations.

Also, Secure Display failures could point to a deeper issue with the AMD GPU's PSP, which plays a role in power management and system state transitions.

So, first I updated the GPU firmware with `sudo pacman -S amd-ucode`. 

Then I disabled secure display (by adding `amdgpu.securedisplay=0`) to my `linux.conf` (the kernel options from before).

Disabling Secure Display on an AMD GPU means turning off a feature that uses the Platform Security Processor (PSP) to ensure the integrity of visual output, particularly for DRM-protected content. Secure Display ensures that sensitive visual data (e.g., movies or applications using DRM) cannot be intercepted or tampered with.

##### What Is Secure Display? 

**Purpose**: Secure Display protects sensitive graphical data during rendering and transmission to the screen. 
- Commonly used for DRM (Digital Rights Management) in services like Netflix, Amazon Prime, or other streaming platforms to prevent screen capture or tampering. 
- It leverages the PSP to securely manage encryption keys and verify data integrity. 
**Implementation**: The PSP loads a Trusted Application (TA) to manage these operations. Errors like psp gfx command LOAD_TA failed indicate that the TA is failing to initialize. 

##### What Happens When Secure Display Is Disabled? 

 - No DRM Content Protection: If Secure Display is disabled, applications requiring DRM (e.g., HDCP for video playback) might fall back to lower-quality streams or fail to play entirely. 
 - Improved Stability: By disabling Secure Display, the GPU no longer attempts to initialize the failing PSP functions, which can improve system stability if these errors are causing crashes or freezes (as in your case). 
 - No Impact for Most Users: 
	 - If you’re not using DRM-restricted content, Secure Display being off won't affect you.
	 - Open-source software, non-DRM games, and most general-purpose applications don't rely on this feature.
##### Why Disable It? 

You disable Secure Display to:
- Avoid issues related to PSP initialization failures, such as suspend/resume problems or freezes.
- Eliminate a feature that's not essential for most users, especially if you don’t require DRM-protected content on your device.
In this case, the logs show that the PSP failed to load the Secure Display Trusted Application (LOAD_TA failed), which suggests that this feature is misbehaving and could be contributing to your system freeze during suspend/resume.

##### Is It Safe to Disable?

Disabling Secure Display is safe for most users: 
- It doesn’t impact general system performance or functionality. 
- DRM-restricted content might behave differently, but this is rarely an issue for most workflows.

If you rely heavily on DRM-restricted media (e.g., watching HD Netflix or playing DRM-protected games), you may notice lower-quality playback or errors. Otherwise, it’s unlikely you’ll notice any difference.

After updating `amd-ucode` and disabling Secure Display, the problem persisted. I've left the Secure Display disabled anyway.

### Testing with the LTS kernel

The mainline kernel (6.12) could have a regression affecting AMD GPUs. So i've tried next to use the LTS kernel (6.6).

I rebooted and chose the LTS kernel (which I had already installed) and the problem was finally solved!

After that I updated `/boot/loader/loader.conf` adding `default 2024-11-17_12-14-43_linux-lts.conf` to the file.

`uname -r` confirmed I've successfully changed to the lts kernel.

